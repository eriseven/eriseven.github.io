---
layout: post
title: 蒙特卡罗方法简介
---
[原文](https://www.scratchapixel.com/lessons/mathematics-physics-for-computer-graphics/monte-carlo-methods-mathematical-foundations)

最初我们不希望这么长时间的课,包含如此多的概率和统计信息,但事实是,如果你想了解蒙特卡罗方法,你需要覆盖在概率论与数理统计理论。

在这一章,我们将试图给这些蒙特卡罗方法是什么,它们是如何工作的,为什么,他们用于。这种快速的介绍,读者没有时间或得到任何进一步的欲望。但是你可能需要阅读所有剩下的章节,如果你是认真的学习这些方法是什么。

这节课是介绍蒙特卡洛方法的数学工具。方法本身的解释下节课(蒙特卡罗方法在实践中)。

## 关于蒙特卡洛
就像许多其他在CG文献中经常出现的术语，蒙特卡洛对于初学者是一个神奇的词汇。一些在计算机图形学中使用的数学工具某种程度上比较复杂，例如球谐函数，蒙特卡洛的原理就其本身而言相对简单(并不意味着容易)。这很棒，因为这种方法能极其方便的解决各种复杂的问题。蒙特卡洛积分或蒙特卡罗近似可能是一个很古老的方法，可直到1940年代中期才有了这个朗朗上口的名字。蒙特卡洛是摩纳哥公国的一个地区，以其赌场闻名于世。如同我们将在本课程中讲解的，蒙特卡洛方法与统计领域有很紧密的联系，它本身对提升你在一场机会游戏中输赢的机会很有帮助，比如轮盘，或任何其他涉及到掷骰子，抽牌等机会游戏，都被看作是一个随机过程。方法本身是由一批著名数学家帮助开发并形式化(费米，乌兰，冯·诺依曼，梅特罗波利斯等)对于原子弹开发的研究开展是至关重要的，在计算机紧密相关的现代科学中非常流行(冯诺伊曼本人发明了第一代计算机)。蒙特卡洛积分需要大量计算，如果没有计算机的参与，它将非常乏味冗长，而大规模计算恰好是计算机所擅长的。现在我们回顾了关于蒙特卡洛的历史和最初的命名的起源，让我们尝试解释下什么是蒙特卡洛。可惜，我们前面的介绍很简短，蒙特卡洛方法的数学意义涉及到许多统计学和概率论的重要概念。在着眼介绍蒙特卡洛方法前，我们首先要和大家回顾这些概念。

![picture](https://www.scratchapixel.com/images/upload/monte-carlo-methods/roulette.png?)

## 蒙特卡洛方法简介
![pictrue](https://www.scratchapixel.com/images/upload/monte-carlo-methods/jellybeans01.png?) 

蒙特卡罗是什么？蒙特卡洛方法背后的概念既简单又健壮。然而，很快我们会发现，它需要大量的计算量，这就是为什么它的普及时间与计算机技术的出现相一致的原因。生活中的许多事情都很难准确评估，尤其是涉及到非常大的数字时。例如，虽然并非不可能，但要计算1公斤的罐子可能包含的果冻豆的数量可能要花很长时间。你可以用手来数一数，但这可能要花很长时间(这可不是最令人喜欢的工作)。计算一个国家成年人口的平均身高，需要测量每个人的身高，并将其相加，并将其除以总人数。这是一项可能需要很长时间的任务。我们可以做的是取这个总体的样本然后计算它的平均高度。它不可能准确地给出整个种群的平均高度，但是这个方法给出了一个很近似于真实结果的数字。我们为了速度而放弃了准确性。抽样调查也被称为数据统计就是基于这一我们所熟知的原则的。有趣的是，近似值和整个总体的准确平均值可能有些时候是完全相同的。这只是由于偶然。在大多数情况下，数字将会有所差异。我们可能想问的一个问题是，差异有多大？事实上，随着样本数量的增大，这个近似值收敛于精确的数值。换句话说，近似和实际结果之间的误差随着样本容量的减小而减小。我们为了速度而放弃了准确性。民调也被称为统计数据是基于这一原则的，我们都很熟悉这一原则。有趣的是，整个种群的近似和准确的平均值可能有些时候是完全相同的。这只是由于偶然。在大多数情况下，数字将会有所不同。我们可能想问的一个问题是，有什么不同吗?事实上，随着样本容量的增大，这个近似收敛于精确的数值。换句话说，近似和实际结果之间的误差随着样本数量的增加而减小。直觉上，这个想法很容易理解，但是在下一章中，我们会将它(从数学的角度)公式化，用另一种不同的方式阐述这个概念。请注意，为了公平起见，样本的元素需要随机选择的概率是相等的。 


注意，一个人的身高是一个随机数。实际上可以是任何有随机性质的东西。因此，当你对一个统计总体进行抽样时，通过随机选取这个总体的元素，并测量它们的高度来接近平均高度，每一个测量结果都是一个随机值(因为样本中的每个人可能有不同的高度)。有趣的是，随机值的总和，是另一个随机值。如果你不能预测每一个用来求和的值是多少，你怎么能预测它们的和的结果呢？因此，求和的结果是一个随机值。

对于一个数学家来说，人口的高度会被称为随机变量，因为组成这个总体的人的身高是随机的。我们通常用大写字母表示随机变量。比如大写字母$X$。


在统计学中，构成总体的要素，如之前所建议的是随机的，用一个小写字母表示，通常是$x$。例如，如果我们写$x_2$，这表示的是第二个人的身高(这是随机的)。所有这些$x$也可以被看作是随机变量$X$的可能结果，如果我们称$X$为随机变量(人口高度)，我们可以用下面的伪数学公式来表示近似成人平均身高的概念:

$$Approximation(Average(X)) = { 1 \over N} \sum_{n=1}^N x_n.$$

可以理解为,随机变量$X$平均值的近似值,(一个特定国家的成年人口的高度),等于从这个总体随机选择$N$个成人的高度(样品)的总和($\Sigma$符号),除以$N$(样本数量)。这就是我们所说的蒙特卡罗近似。它是指,对于一组庞大数量个体的一些属性,通过从该总体随机选择$N$个个体的性质的求平均值作为该总体属性的近似值。你也可以说，蒙特卡罗近似，实际上是一个用样本做近似值的方法。下一章我们将学到的是，需要近似的东西被称为数学期望。如前所述一个给定的国家的成年人口的高度可以被看作是一个随机变量$X$。但是需要注意，其平均值(你得到平均每个人的身高例如人口组成,每一个数字也是一个随机数)是唯一的(为了避免与样本数量(通常用字母$N$表示)混淆,我们将使用$M$表示整个总体的大小):

$$Average(X) = { 1 \over M\ } (x_1 + x_2 + ... x_M),$$

这里$x_1, x_2, ... x_M$对应组成前面的总体的每个人的身高(如果我们要举个例子)。在统计学中，随机变量X的平均值被称为期望，并被写成E(X)。

>总而言之，蒙特卡罗近似（这是MC方法之一）是一种利用样本来近似随机变量期望的技术。可以用下面的公式来定义它：
>
>$$E(X) \approx { 1 \over N } \sum_{n = 1}^N x_n.$$
>这个数学符号表示，这个符号的右边的公式只给出了随机变量X期望E(X)实际上是什么的"近似"。注意，在某种程度上，它只是随机值（ $x_n$ s）的平均值。

如果你只是想知道隐藏在这个神秘术语蒙特卡罗背后的秘密，那么你可能想知道的就是这个。但是，对于这个快速入门的介绍，让我们来解释一下为什么这个方法是有用的。就像之前说的那样，计算E(X)有时是很难处理的。这意味着你不能以一种有效的方式计算E(X)。尤其当大量的“人口”在计算E(X)的时候，例如计算一个国家成年人口的平均身高时，这是非常正确的。在这种情况下，MC近似提供了一个非常简单和快速的方法来至少近似这个期望。它不会给出确切的值，但它可能非常接近于计算E(X)所需要的花费的一小部分，如果或者可能的话。

## 蒙特卡罗，偏置和无偏射线追踪
为了结束这个简短的介绍，我们认识到你们中很多人都听说过蒙特卡罗射线追踪这个术语，还有偏置和无偏的射线追踪这个词，很可能是看了这个页面，希望能找到解释这些术语的意思。让我们快速地做一下，尽管我们确实建议你们阅读这一课的其余部分以及下面的内容，以便深入地回答这些问题。

![picture](https://www.scratchapixel.com/images/upload/monte-carlo-methods/areacam1.png?)



想象一下你想用数码相机拍张照片。如果你把图像的表面分割成一个普通的网格（我们的像素），注意每一个像素实际上都可以被看作是小的，但是仍然是连续的，在这个场景中，由物体所反射的光会落到上面。这光最终会转化为单一颜色(我们稍后将讨论这个过程)但是如果你浏览这些像素,您可能注意到,实际上看到不止一个对象,或者物体的表面的颜色,它认为,在像素的不同区域。我们已经在图1中说明了这个想法。理想情况下，我们要做的是计算从这个表面上反射的光的量。这是一个典型的棘手问题，从某种意义上说，没有办法可以在一个像素的表面上整合，通过这个像素的光量。虽然我们可以用数学方法来写这个想法，但是这个方程实际上并没有解。

$$L_{pixel} = \int_{pixel area} L(x_p) dA$$,


L在这里，代表辐射（正如在放射测量学中解释的那样）。你可以阅读这个方程的“实际数量到达一个像素(L方程左边也该像素的颜色,最终得救)可以作为输入的积分计算辐射(光的像素)像素区”。就像我们刚才说的，这个问题没有解析解，因此我们需要用数值近似。

![picture](https://www.scratchapixel.com/images/upload/monte-carlo-methods/areacam2.png?)


这里的原理很简单。它由近似于这个积分的结果，通过在像素区域的几个位置采样像素的表面。换句话说，就像蒙特卡罗近似一样，我们将使用“随机抽样”来评估这个积分（并得到一个近似值）。我们需要的是，在像素区域中选择一些随机的采样点，并将它们的颜色平均。现在的问题是我们如何找到这些样本的颜色？当然使用射线追踪！光线会像往常一样从眼睛的位置开始，但是会通过每个随机放置的样本分布在像素区域（图2）。样品的颜色将会是光线在相交点与场景中的物体的颜色。在数学上,我们可以写:


$$L_{pixel} \approx {1 \over N } \sum_{n=1}^N L(x_n),$$

$L(x_n)$表示样本颜色。像往常一样，这只是一个近似值（因此是$\approx$符号）。这种方法被称为蒙特卡罗积分法（尽管与蒙特卡罗近似法相似，但在这种情况下，它被用来求积分的近似值）。对蒙特卡罗集成方法的正式定义感兴趣的读者可以参考下一节课。这只是对这个概念的一个非正式和快速的介绍。


```c++
#include <fstream> 
#include <cstdlib> 
#include <cstdio> 
 
int main(int argc, char **argv) 
{ 
        std::ifstream ifs; 
        ifs.open("./tex.pbm"); 
        std::string header; 
        uint32_t w, h, l; 
        ifs >> header; 
        ifs >> w >> h >> l; 
        ifs.ignore(); 
        unsigned char *pixels = new unsigned char[w * h * 3]; 
        ifs.read((char*)pixels, w * h * 3); 
        // sample
        int nsamples = 8; 
        srand48(13); 
        float avgr = 0, avgg = 0, avgb = 0; 
        float sumr = 0, sumg = 0, sumb = 0; 
        for (int n = 0; n < nsamples; ++ n) { 
                float x = drand48() * w; 
                float y = drand48() * h; 
                int i = ((int)(y) * w + (int)(x)) * 3; 
                sumr += pixels[i]; 
                sumg += pixels[i + 1]; 
                sumb += pixels[i + 2]; 
        } 
        sumr /= nsamples; 
        sumg /= nsamples; 
        sumb /= nsamples; 
        for (int y = 0; y < h; ++y) { 
                for (int x = 0; x < w; ++x) { 
                        int i = (y * w + x) * 3; 
                        avgr += pixels[i]; 
                        avgg += pixels[i + 1]; 
                        avgb += pixels[i + 2]; 
                } 
        } 
        avgr /= w * h; 
        avgg /= w * h; 
        avgb /= w * h; 
        printf("Average %0.2f %0.2f %0.2f, Approximation %0.2f %0.2f %0.2f\n", avgr, avgg, avgb, sumr, sumg, sumb); 
        delete [] pixels; 
        return 0; 
} 
```